# linkCUP Plugin - 修复日志

## 修复内容

### 问题 1: 远程服务器上UI显示问题
**问题描述**: 在远程Ubuntu服务器上通过Nginx反向代理访问SillyTavern时，插件的linkCUP窗口无法显示蓝牙产品上报的动作参数。

**解决方案**:
1. **删除冲突文件**: 移除了 `public/script.js` 文件，该文件与主入口 `index.js` 产生冲突
2. **改进UI加载逻辑**: 在 `index.js` 中实现了多路径加载机制，确保在不同环境（本地和远程）下都能正确加载UI文件
3. **路径兼容性**: 添加了相对路径和绝对路径的备用方案，提高在反向代理环境下的兼容性

### 问题 2: 呼吸音频逻辑优化
**问题描述**: 需要在D=0持续超过0.5秒时，根据B值动态周期性播放呼吸音频。

**解决方案**:
1. **精确时间控制**: 将基于计数器的检测改为基于真实时间的检测（`Date.now()`），确保0.5秒的精确判断
2. **动态周期播放**: 实现了根据B值（兴奋程度）动态调整播放间隔的机制：
   - B=1: 每3秒播放一次
   - B=2: 每2秒播放一次
   - B=3: 每1秒播放一次
   - B=4: 每0.75秒播放一次
   - B=5: 每0.6秒播放一次
3. **实时参数更新**: 呼吸循环会使用最新的P值和B值进行文件筛选和播放间隔调整
4. **音频文件筛选**: 完善了根据P值（体位）和B值（兴奋程度）筛选音频文件的逻辑

## 技术细节

### 修改的文件
- `index.js`: 改进UI加载逻辑，增加多路径支持
- `audioManager.js`: 重构呼吸音频逻辑，实现精确时间控制和动态播放
- 删除: `public/script.js` (冲突文件)

### 新增功能
- 精确的0.5秒D=0检测
- 基于B值的动态播放间隔
- 实时参数更新机制
- 改进的远程环境兼容性

## 测试建议
1. 在本地环境测试插件功能是否正常
2. 在远程服务器环境测试UI是否正确显示
3. 测试D=0持续0.5秒后是否正确触发呼吸音频
4. 验证不同B值下的播放间隔是否正确